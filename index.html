<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Lesson Planner Pro</title>
    
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <style>
        :root { --primary: #2563eb; --primary-hover: #1d4ed8; --bg: #f1f5f9; --surface: #ffffff; --text: #0f172a; --border: #cbd5e1; --success: #22c55e; --error: #ef4444; }
        body { font-family: -apple-system, system-ui, sans-serif; background: var(--bg); color: var(--text); line-height: 1.6; margin: 0; padding: 20px; }
        .container { max-width: 950px; margin: 0 auto; background: var(--surface); border-radius: 12px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); overflow: hidden; }
        
        /* TABS */
        .tabs { display: flex; background: #e2e8f0; border-bottom: 1px solid var(--border); }
        .tab-btn { flex: 1; padding: 1rem; border: none; background: transparent; cursor: pointer; font-weight: 600; color: #64748b; transition: 0.2s; }
        .tab-btn:hover { background: #cbd5e1; color: var(--text); }
        .tab-btn.active { background: var(--surface); color: var(--primary); border-top: 3px solid var(--primary); }

        /* SECTIONS & GRID */
        .section { display: none; padding: 2rem; }
        .section.active { display: block; }
        .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1.5rem; }
        .full-width { grid-column: 1 / -1; }
        
        /* INPUTS */
        label { display: block; font-weight: 600; margin-bottom: 0.5rem; font-size: 0.9rem; }
        input[type="text"], input[type="number"], input[type="password"], select, textarea {
            width: 100%; padding: 0.75rem; border: 1px solid var(--border); border-radius: 6px; font-size: 1rem; box-sizing: border-box;
        }
        .slider-container { display: flex; align-items: center; gap: 10px; }
        input[type="range"] { flex-grow: 1; }
        .val-display { font-weight: bold; color: var(--primary); min-width: 40px; text-align: right; }

        /* BUTTONS */
        .btn-primary { background: var(--primary); color: white; border: none; padding: 1rem; border-radius: 8px; font-weight: bold; cursor: pointer; width: 100%; font-size: 1.1rem; margin-top: 1.5rem; }
        .btn-primary:hover { background: var(--primary-hover); }
        .btn-primary:disabled { background: #94a3b8; cursor: not-allowed; }
        
        .action-bar { display: flex; gap: 0.5rem; margin-top: 1rem; flex-wrap: wrap; border-top: 1px solid var(--border); padding-top: 1rem; }
        .btn-secondary { background: #f1f5f9; color: #334155; border: 1px solid var(--border); padding: 0.5rem 1rem; border-radius: 6px; cursor: pointer; font-size: 0.9rem; }
        .btn-secondary:hover { background: #e2e8f0; }
        .btn-save { background: #dcfce7; color: #166534; border-color: #bbf7d0; }
        .btn-save:hover { background: #bbf7d0; }
        .btn-danger { background: #fee2e2; color: #991b1b; border-color: #fecaca; padding: 4px 10px; font-size: 0.8rem; cursor: pointer; }

        /* OUTPUT STYLES */
        #outputArea { margin-top: 1.5rem; min-height: 200px; }
        #outputArea table { width: 100%; border-collapse: collapse; margin: 1rem 0; }
        #outputArea th, #outputArea td { border: 1px solid var(--border); padding: 0.75rem; text-align: left; }
        #outputArea th { background: #f8fafc; }
        #markdownEditor { width: 100%; min-height: 400px; font-family: monospace; padding: 1rem; display: none; line-height: 1.4; border: 1px solid var(--border); border-radius: 6px; }

        /* HISTORY PANEL */
        #historyPanel { background: #f8fafc; border: 1px solid var(--border); border-radius: 6px; padding: 1rem; margin-top: 1rem; display: none; }
        .history-item { display: flex; justify-content: space-between; align-items: center; padding: 10px; border-bottom: 1px solid #e2e8f0; font-size: 0.9rem; background: white; margin-bottom: 5px; border-radius: 4px; border:1px solid transparent; }
        .history-item:hover { border-color: var(--primary); background: #eff6ff; }
        .history-actions { display: flex; gap: 8px; }
        .btn-mini { padding: 2px 6px; font-size: 0.75rem; border-radius: 4px; border: 1px solid #cbd5e1; cursor: pointer; background: white; }
        .btn-mini:hover { background: #f1f5f9; }
        
        /* TOAST */
        #toast-container { position: fixed; top: 20px; right: 20px; z-index: 2000; display: flex; flex-direction: column; gap: 10px; }
        .toast { background: #333; color: #fff; padding: 12px 20px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); font-size: 0.95rem; animation: slideIn 0.3s ease-out; display: flex; align-items: center; gap: 10px; min-width: 250px; }
        .toast.success { background: var(--success); } .toast.error { background: var(--error); }
        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }

        /* MODAL */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; display: none; justify-content: center; align-items: center; }
        .modal-content { background: white; width: 90%; max-width: 800px; max-height: 90vh; border-radius: 12px; display: flex; flex-direction: column; box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1); }
        .modal-header { padding: 1rem 1.5rem; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; background: #f8fafc; border-radius: 12px 12px 0 0; }
        .modal-body { padding: 1.5rem; overflow-y: auto; font-size: 0.95rem; }
        .modal-footer { padding: 1rem 1.5rem; border-top: 1px solid var(--border); display: flex; justify-content: flex-end; gap: 1rem; background: #f8fafc; border-radius: 0 0 12px 12px; }

        /* BANK GRID */
        .bank-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 1rem; }
        .plan-card { border: 1px solid var(--border); border-radius: 8px; padding: 1rem; background: #fff; display: flex; flex-direction: column; justify-content: space-between; transition: 0.2s; }
        .plan-card:hover { border-color: var(--primary); transform: translateY(-2px); }
        .plan-meta { font-size: 0.8rem; color: #64748b; margin-bottom: 0.5rem; }
        .tag { background: #e0f2fe; color: #0369a1; padding: 2px 8px; border-radius: 12px; font-size: 0.75rem; font-weight: 600; }
        .actions-row { display: flex; justify-content: space-between; margin-top: 1rem; padding-top: 0.5rem; border-top: 1px solid #f1f5f9; }
    </style>
</head>
<body>

<div id="toast-container"></div>

<div id="historyModal" class="modal-overlay">
    <div class="modal-content">
        <div class="modal-header">
            <h3 style="margin:0">üìú History Preview</h3>
            <button onclick="closeModal()" style="background:none; border:none; font-size:1.5rem; cursor:pointer;">&times;</button>
        </div>
        <div class="modal-body" id="modalBody"></div>
        <div class="modal-footer">
            <button class="btn-secondary" onclick="closeModal()">Close</button>
            <button id="confirmRestoreBtn" class="btn-primary" style="margin:0; width:auto;">Restore This Version</button>
        </div>
    </div>
</div>

<div class="container">
    <div class="tabs">
        <button class="tab-btn active" onclick="switchTab('generator')">‚ú® Generator</button>
        <button class="tab-btn" onclick="switchTab('bank')">üìÇ Lesson Plan Bank</button>
    </div>

    <div id="tab-generator" class="section active">
        
        <div style="background:#f8fafc; padding:1.5rem; border-radius:8px; margin-bottom:1.5rem; border:1px solid var(--border);">
            <h3 style="margin-top:0;">API Setup</h3>
            <div class="form-grid">
                <div>
                    <label>OpenRouter API Key <span style="color:red">*</span></label>
                    <input type="password" id="apiKey" placeholder="sk-or-...">
                </div>
                <div>
                    <label>AI Model</label>
                    <select id="modelSelect">
                        <option value="openai/gpt-4o">ChatGPT 4o</option>
                        <option value="google/gemini-flash-1.5">Gemini 1.5 Flash</option>
                        <option value="openai/gpt-4o-mini">ChatGPT 4o Mini</option>
                        <option value="deepseek/deepseek-chat">DeepSeek V3</option>
                    </select>
                </div>
            </div>
        </div>

        <div id="editModeBar">
            <span>‚úèÔ∏è <b>Editing Mode:</b> Updating an existing plan.</span>
            <button class="btn-secondary" onclick="exitEditMode()">Cancel / New</button>
        </div>

        <div class="form-grid">
            <div>
                <label>Age Range</label>
                <div class="slider-container">
                    <input type="range" id="ageRange" min="5" max="60" value="12" step="1" oninput="updateRangeDisplay()">
                    <span id="ageVal" class="val-display">12-14</span>
                </div>
            </div>
            <div>
                <label>Group Size</label>
                <div class="slider-container">
                    <input type="range" id="groupSize" min="1" max="50" value="15" step="1" oninput="updateRangeDisplay()">
                    <span id="groupVal" class="val-display">15</span>
                </div>
            </div>
            <div>
                <label>English Type</label>
                <input type="text" id="engType" list="engTypeSuggestions" placeholder="e.g. General English">
                <datalist id="engTypeSuggestions"><option value="General English"><option value="Business English"></datalist>
            </div>
            <div>
                <label>CEFR Level</label>
                <select id="cefrLevel"><option value="A1">A1</option><option value="A2">A2</option><option value="B1">B1</option><option value="B2">B2</option><option value="C1">C1</option></select>
            </div>
            <div class="full-width">
                <label>Topic</label>
                <input type="text" id="topic" placeholder="e.g. Present Perfect Simple">
            </div>
            <div class="full-width">
                <label>Theme</label>
                <input type="text" id="theme" placeholder="e.g. A job interview">
            </div>
            <div>
                <label>Temperature</label>
                <div class="slider-container">
                    <input type="range" id="temperature" min="0.1" max="1.0" step="0.1" value="0.7" oninput="document.getElementById('tempVal').textContent = this.value">
                    <span id="tempVal" class="val-display">0.7</span>
                </div>
            </div>
            <div>
                <label>Max Tokens</label>
                <input type="number" id="maxTokens" value="3000">
            </div>
        </div>

        <button id="generateBtn" class="btn-primary" onclick="generateLesson()">Generate Lesson Plan</button>

        <div id="outputContainer" style="display:none; margin-top:2rem; border-top:2px solid var(--border); padding-top:1rem;">
            
            <div id="historyPanel">
                <h4>üìú Version History (Max 5)</h4>
                <div id="historyList"></div>
            </div>

            <div class="action-bar">
                <button class="btn-secondary" onclick="toggleEditView()">‚úèÔ∏è Edit Text</button>
                <button class="btn-secondary" onclick="exportPDF()">üìÑ Export PDF</button>
                <button class="btn-secondary" onclick="copyToClipboard()">üìã Copy</button>
                <button id="saveBtn" class="btn-secondary btn-save" onclick="saveToFirebase()">üíæ Save to Bank</button>
            </div>
            
            <div id="outputWrapper">
                <div id="outputArea"></div>
                <textarea id="markdownEditor"></textarea>
            </div>
        </div>
    </div>

    <div id="tab-bank" class="section">
        <h2 style="margin-top:0;">Saved Lesson Plans</h2>
        <div id="bankGrid" class="bank-grid"><p><i>Loading plans...</i></p></div>
    </div>

</div>

<script>
    // --- 1. CONFIG ---
    const firebaseConfig = {
        apiKey: "AIzaSyB-C2KHU6owoFFkGfhkDeZh3wTxCh7N4LY",
        authDomain: "test2lessplanner.firebaseapp.com",
        projectId: "test2lessplanner",
        storageBucket: "test2lessplanner.firebasestorage.app",
        messagingSenderId: "823891327290",
        appId: "1:823891327290:web:4b9f5331d8449525cf7803",
        measurementId: "G-K1GZDZR0NQ"
    };
    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // --- 2. STATE ---
    let editingDocId = null;
    let isManualEditMode = false;
    let currentGenerationId = null;
    let loadedDocData = null;
    let tempHistoryMarkdown = ""; 

    // --- 3. TOAST & MODAL ---
    function showToast(message, type = 'success') {
        const container = document.getElementById('toast-container');
        const toast = document.createElement('div');
        toast.className = `toast ${type}`;
        toast.innerHTML = `<span>${type==='success'?'‚úÖ':type==='error'?'‚ùå':'‚ÑπÔ∏è'}</span> <span>${message}</span>`;
        container.appendChild(toast);
        setTimeout(() => {
            toast.style.opacity = '0';
            setTimeout(() => toast.remove(), 300);
        }, 3000);
    }

    function openModal(markdown) {
        const modal = document.getElementById('historyModal');
        const body = document.getElementById('modalBody');
        const btn = document.getElementById('confirmRestoreBtn');

        body.innerHTML = marked.parse(markdown);
        // Table styling
        body.querySelectorAll('table').forEach(t => { t.style.width="100%"; t.style.borderCollapse="collapse"; t.style.marginBottom="1rem"; });
        body.querySelectorAll('th, td').forEach(c => { c.style.border="1px solid #cbd5e1"; c.style.padding="0.5rem"; });

        tempHistoryMarkdown = markdown;
        btn.onclick = () => restoreVersion();
        modal.style.display = 'flex';
    }

    // --- NEW HELPER: OPEN PREVIEW SAFELY ---
    function openHistoryPreview(uid) {
        if(!loadedDocData || !loadedDocData.history) return;
        const item = loadedDocData.history.find(h => {
            const hId = h.timestamp.seconds || new Date(h.timestamp).getTime();
            return hId === uid;
        });
        if(item) openModal(item.markdown);
        else showToast("Version not found", "error");
    }

    function closeModal() {
        document.getElementById('historyModal').style.display = 'none';
        tempHistoryMarkdown = "";
    }

    function restoreVersion() {
        const outputArea = document.getElementById('outputArea');
        outputArea.dataset.markdown = tempHistoryMarkdown;
        outputArea.innerHTML = marked.parse(tempHistoryMarkdown);
        if(isManualEditMode) { document.getElementById('markdownEditor').value = tempHistoryMarkdown; }
        closeModal();
        showToast("Version Restored. Click Update to save.");
    }

    // --- 4. UI FUNCTIONS ---
    function switchTab(tabName) {
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
        const btnIndex = tabName === 'generator' ? 0 : 1;
        document.querySelectorAll('.tab-btn')[btnIndex].classList.add('active');
        document.getElementById(`tab-${tabName}`).classList.add('active');
    }
    function updateRangeDisplay() {
        const age = document.getElementById('ageRange').value;
        document.getElementById('ageVal').textContent = `${age}-${parseInt(age)+2}`;
        document.getElementById('groupVal').textContent = document.getElementById('groupSize').value;
    }
    function toggleEditView() {
        const viewer = document.getElementById('outputArea');
        const editor = document.getElementById('markdownEditor');
        const btn = document.querySelector('button[onclick="toggleEditView()"]');
        if (!isManualEditMode) {
            editor.value = viewer.dataset.markdown || "";
            viewer.style.display = 'none'; editor.style.display = 'block';
            btn.textContent = "üëÅÔ∏è Preview"; isManualEditMode = true;
        } else {
            const updated = editor.value;
            viewer.dataset.markdown = updated;
            viewer.innerHTML = marked.parse(updated);
            viewer.style.display = 'block'; editor.style.display = 'none';
            btn.textContent = "‚úèÔ∏è Edit Text"; isManualEditMode = false;
        }
    }

    // --- 5. GENERATION ---
    async function generateLesson() {
        const apiKey = document.getElementById('apiKey').value;
        if (!apiKey) { showToast("Enter API Key", "error"); return; }
        const btn = document.getElementById('generateBtn');
        btn.disabled = true; btn.textContent = "Generating...";
        
        document.getElementById('outputContainer').style.display = 'block';
        const outputArea = document.getElementById('outputArea');
        
        isManualEditMode = false;
        document.getElementById('markdownEditor').style.display = 'none';
        outputArea.style.display = 'block';
        outputArea.innerHTML = '<p>Thinking...</p>';
        
        currentGenerationId = "gen_" + Date.now();
        let fullMarkdown = "";

        const promptUser = `
        LESSON CONTEXT:
        Subject: ${document.getElementById('engType').value}
        Topic: ${document.getElementById('topic').value}
        Theme: ${document.getElementById('theme').value}
        Level: ${document.getElementById('cefrLevel').value}
        Age: ${document.getElementById('ageVal').textContent}
        Group Size: ${document.getElementById('groupSize').value}
        TASK: Create a full PPP lesson plan. Output strictly in Markdown.
        `;

        try {
            const response = await fetch("https://openrouter.ai/api/v1/chat/completions", {
                method: "POST",
                headers: { "Authorization": `Bearer ${apiKey}`, "Content-Type": "application/json" },
                body: JSON.stringify({
                    model: document.getElementById('modelSelect').value,
                    messages: [{role: "system", content: "You are an expert ESL lesson planner."}, {role: "user", content: promptUser}],
                    temperature: parseFloat(document.getElementById('temperature').value),
                    max_tokens: parseInt(document.getElementById('maxTokens').value),
                    stream: true 
                })
            });
            const reader = response.body.getReader();
            const decoder = new TextDecoder("utf-8");
            outputArea.innerHTML = "";
            while (true) {
                const { done, value } = await reader.read();
                if (done) break;
                const chunk = decoder.decode(value);
                const lines = chunk.split("\n");
                lines.forEach(line => {
                    if (line.startsWith("data: ") && line !== "data: [DONE]") {
                        try {
                            const parsed = JSON.parse(line.replace("data: ", ""));
                            const content = parsed.choices[0]?.delta?.content || "";
                            fullMarkdown += content;
                            outputArea.innerHTML = marked.parse(fullMarkdown);
                        } catch(e){}
                    }
                });
            }
            showToast("Lesson Generated!");
        } catch (error) {
            outputArea.innerHTML = `<p style="color:red">Error: ${error.message}</p>`;
            showToast("Failed to generate", "error");
        } finally {
            btn.disabled = false; btn.textContent = "Generate Lesson Plan";
            outputArea.dataset.markdown = fullMarkdown;
        }
    }

    // --- 6. SAVING (WITH LIMIT 5) ---
    function saveToFirebase() {
        const btn = document.getElementById('saveBtn');
        const markdown = isManualEditMode ? document.getElementById('markdownEditor').value : document.getElementById('outputArea').dataset.markdown;
        if (!markdown) { showToast("No plan to save!", "error"); return; }

        btn.disabled = true; btn.textContent = "Saving...";

        const payload = {
            metadata: {
                level: document.getElementById('cefrLevel').value,
                subject: document.getElementById('engType').value,
                theme: document.getElementById('theme').value,
                age: document.getElementById('ageVal').textContent,
                group_size: document.getElementById('groupSize').value,
                topic: document.getElementById('topic').value
            },
            ai_model: document.getElementById('modelSelect').value,
            generation_settings: {
                tokens: parseInt(document.getElementById('maxTokens').value),
                temperature: parseFloat(document.getElementById('temperature').value)
            },
            full_generated_lesson: markdown,
            generation_id: currentGenerationId || "manual_edit_" + Date.now()
        };

        if(!editingDocId) {
            payload.created_at = firebase.firestore.FieldValue.serverTimestamp();
            payload.history = [];
            db.collection("lesson_plans").add(payload)
                .then(() => { showToast("Saved!"); btn.disabled = false; btn.textContent = "Save to Bank"; })
                .catch(e => { showToast(e.message, "error"); btn.disabled = false; });
        } else {
            payload.updated_at = firebase.firestore.FieldValue.serverTimestamp();
            
            let currentHistory = loadedDocData.history || [];
            const historyEntry = {
                timestamp: new Date(),
                markdown: loadedDocData.full_generated_lesson || loadedDocData.full_plan_markdown,
                generation_id: loadedDocData.generation_id || "unknown"
            };
            currentHistory.push(historyEntry);

            if (currentHistory.length > 5) {
                currentHistory = currentHistory.slice(currentHistory.length - 5);
            }

            const updatePayload = { ...payload, history: currentHistory };

            db.collection("lesson_plans").doc(editingDocId).update(updatePayload)
                .then(() => {
                    showToast("Updated! History saved (Max 5).");
                    btn.disabled = false; btn.textContent = "Save to Bank";
                    loadedDocData.full_generated_lesson = markdown;
                    loadedDocData.history = currentHistory;
                    exitEditMode();
                })
                .catch(e => { showToast(e.message, "error"); btn.disabled = false; });
        }
    }

    // --- 7. HISTORY ACTIONS (FIXED ID PASSING) ---
    function renderHistoryList(historyArray) {
        const historyList = document.getElementById('historyList');
        historyList.innerHTML = "";
        
        if (!historyArray || historyArray.length === 0) {
            document.getElementById('historyPanel').style.display = 'none';
            return;
        }

        document.getElementById('historyPanel').style.display = 'block';

        [...historyArray].reverse().forEach((ver) => {
            const dateStr = ver.timestamp && ver.timestamp.seconds 
                ? new Date(ver.timestamp.seconds * 1000).toLocaleString() 
                : new Date(ver.timestamp).toLocaleString();
            
            // Unique ID based on timestamp
            const uniqueId = ver.timestamp.seconds || new Date(ver.timestamp).getTime();

            const item = document.createElement('div');
            item.className = 'history-item';
            
            // PASS ID, NOT STRING
            item.innerHTML = `
                <div>
                    <span>üìÖ ${dateStr}</span>
                </div>
                <div class="history-actions">
                    <button class="btn-mini" onclick="openHistoryPreview(${uniqueId})">üëÅÔ∏è View</button>
                    <button class="btn-mini" style="color:red; border-color:#fca5a5;" onclick="deleteHistoryItem(${uniqueId})">üóëÔ∏è</button>
                </div>
            `;
            historyList.appendChild(item);
        });
    }

    function deleteHistoryItem(idToRemove) {
        if(!confirm("Permanently delete this version?")) return;
        const newHistory = loadedDocData.history.filter(h => {
            const hId = h.timestamp.seconds || new Date(h.timestamp).getTime();
            return hId !== idToRemove;
        });

        db.collection("lesson_plans").doc(editingDocId).update({ history: newHistory })
        .then(() => {
            loadedDocData.history = newHistory;
            renderHistoryList(newHistory);
            showToast("History item deleted");
        }).catch(e => showToast("Error: " + e.message, "error"));
    }

    // --- 8. BANK LOGIC ---
    db.collection("lesson_plans").orderBy("created_at", "desc").limit(20).onSnapshot(s => {
        const grid = document.getElementById('bankGrid');
        grid.innerHTML = "";
        if(s.empty) { grid.innerHTML = "<p>No plans.</p>"; return; }
        s.forEach(doc => {
            const data = doc.data();
            const topic = data.metadata?.topic || data.topic || "Untitled";
            const level = data.metadata?.level || data.level || "?";
            const date = data.created_at ? data.created_at.toDate().toLocaleDateString() : "N/A";
            
            const card = document.createElement('div');
            card.className = "plan-card";
            card.innerHTML = `
                <div onclick="loadForEditing('${doc.id}')" style="cursor:pointer">
                    <h4 style="margin:0 0 0.5rem 0; color:var(--primary);">${topic}</h4>
                    <div class="plan-meta"><span class="tag">${level}</span> ${date}</div>
                </div>
                <div class="actions-row">
                    <button class="btn-secondary" style="padding:4px 8px; font-size:0.8rem;" onclick="loadForEditing('${doc.id}')">Edit</button>
                    <button class="btn-danger" style="border-radius:4px; border:1px solid #fecaca; cursor:pointer;" onclick="deletePlan('${doc.id}')">Delete</button>
                </div>
            `;
            card.dataset.json = JSON.stringify(data);
            grid.appendChild(card);
        });
    });

    function deletePlan(id) {
        if(confirm("Delete this plan?")) {
            db.collection("lesson_plans").doc(id).delete();
            showToast("Plan Deleted", "success");
        }
    }

    function loadForEditing(id) {
        switchTab('generator');
        const card = Array.from(document.querySelectorAll('.plan-card')).find(el => el.querySelector(`button[onclick="deletePlan('${id}')"]`));
        if(!card) return;
        
        const data = JSON.parse(card.dataset.json);
        loadedDocData = data; 
        editingDocId = id;
        const meta = data.metadata || data; 

        document.getElementById('topic').value = meta.topic || "";
        document.getElementById('theme').value = meta.theme || "";
        document.getElementById('cefrLevel').value = meta.level || "B1";
        document.getElementById('engType').value = meta.subject || "";
        
        const markdown = data.full_generated_lesson || data.full_plan_markdown;
        document.getElementById('outputContainer').style.display = 'block';
        const outputArea = document.getElementById('outputArea');
        outputArea.dataset.markdown = markdown;
        outputArea.innerHTML = marked.parse(markdown);

        document.getElementById('editModeBar').style.display = 'flex';
        document.getElementById('saveBtn').textContent = "Update Plan";

        renderHistoryList(data.history || []);
        window.scrollTo(0,0);
    }

    function exitEditMode() {
        editingDocId = null; loadedDocData = null;
        document.getElementById('editModeBar').style.display = 'none';
        document.getElementById('historyPanel').style.display = 'none';
        document.getElementById('saveBtn').textContent = "Save to Bank";
    }

    function exportPDF() {
        const element = document.getElementById('outputArea');
        html2pdf().set({ margin:1, filename: `plan-${Date.now()}.pdf`, html2canvas:{scale:2}, jsPDF:{unit:'in', format:'letter'} }).from(element).save();
        showToast("Downloading PDF...");
    }
    function copyToClipboard() {
        const text = isManualEditMode ? document.getElementById('markdownEditor').value : document.getElementById('outputArea').dataset.markdown;
        navigator.clipboard.writeText(text).then(() => showToast("Copied!"));
    }
</script>
</body>
</html>
